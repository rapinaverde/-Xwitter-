<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xwitter</title>
  <link rel="stylesheet" href="style.css">
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc,
      addDoc, collection, query, where, getDocs, deleteDoc
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
  
    const firebaseConfig = {
      apiKey: "AIzaSyAjRsShUxXtA8-N2WrSmq4SV8I888MGghQ",
      authDomain: "xwitter-a67bc.firebaseapp.com",
      projectId: "xwitter-a67bc",
      storageBucket: "xwitter-a67bc.firebasestorage.app",
      messagingSenderId: "446604101446",
      appId: "1:446604101446:web:0c56e9f6b2b9c17f9e0747",
      measurementId: "G-DZD8ZFMTGS"
    };
  
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
  
    async function salvarUsuario(username, pic) {
      await setDoc(doc(db, "users", username), { pic });
    }
  
    async function obterUsuario(username) {
      const docRef = doc(db, "users", username);
      const docSnap = await getDoc(docRef);
      return docSnap.exists() ? docSnap.data() : null;
    }
  
    async function salvarTweet(canal, tweet) {
      return await addDoc(collection(db, "tweets"), { canal, ...tweet });
    }
  
    async function carregarTweets(canal) {
      const q = query(collection(db, "tweets"), where("canal", "==", canal));
      const snapshot = await getDocs(q);
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }
  
    async function deletarTweet(tweetId) {
      await deleteDoc(doc(db, "tweets", tweetId));
    }
  
    document.addEventListener("DOMContentLoaded", () => {
      const usernameInput = document.getElementById("usernameInput");
      const profilePicInput = document.getElementById("profilePicInput");
      const authBtn = document.getElementById("authBtn");
      const tweetBox = document.getElementById("tweetBox");
      const postarBtn = document.getElementById("postar");
      const feed = document.getElementById("feed");
      const channelTitle = document.getElementById("channelTitle");
      const profilePic = document.getElementById("profilePic");
  
      // Perfil editÃ¡vel
      const editNameBtn = document.createElement("button");
      editNameBtn.textContent = "Editar Nome/Foto";
      editNameBtn.addEventListener("click", async () => {
        const novoNome = prompt("Novo nome de usuÃ¡rio:", currentUser);
        const novaFotoFile = prompt("Cole a URL da nova imagem de perfil:");
        if (novoNome && novaFotoFile) {
          await salvarUsuario(novoNome, novaFotoFile);
          localStorage.setItem("xwitterUser", novoNome);
          localStorage.setItem("xwitterPic", novaFotoFile);
          alert("InformaÃ§Ãµes atualizadas! Recarregando...");
          location.reload();
        }
      });
  
      let currentUser = "";
      let currentPic = "";
      let currentChannel = "geral";
  
      const savedUser = localStorage.getItem("xwitterUser");
      const savedPic = localStorage.getItem("xwitterPic");
  
      if (savedUser && savedPic) {
        currentUser = savedUser;
        currentPic = savedPic;
        profilePic.src = currentPic;
  
        document.getElementById("authPage").style.display = "none";
        document.getElementById("app").style.display = "flex";
        document.querySelector(".sidebar").appendChild(editNameBtn);
        carregarFeed();
        return;
      }
  
      authBtn.addEventListener("click", async () => {
        const username = usernameInput.value.trim();
        const file = profilePicInput.files[0];
        if (!username) return alert("Digite um nome de usuÃ¡rio");
  
        const userData = await obterUsuario(username);
        if (userData) {
          currentUser = username;
          currentPic = userData.pic || "";
          profilePic.src = currentPic;
          localStorage.setItem("xwitterUser", currentUser);
          localStorage.setItem("xwitterPic", currentPic);
        } else {
          if (!file) return alert("Escolha uma foto para cadastrar.");
          const reader = new FileReader();
          reader.onload = async (e) => {
            currentPic = e.target.result;
            await salvarUsuario(username, currentPic);
            localStorage.setItem("xwitterUser", username);
            localStorage.setItem("xwitterPic", currentPic);
            alert("UsuÃ¡rio cadastrado. FaÃ§a login novamente.");
          };
          reader.readAsDataURL(file);
          return;
        }
  
        document.getElementById("authPage").style.display = "none";
        document.getElementById("app").style.display = "flex";
        document.querySelector(".sidebar").appendChild(editNameBtn);
        carregarFeed();
      });
  
      async function carregarFeed() {
        feed.innerHTML = "";
        channelTitle.textContent = `#${currentChannel}`;
        const tweets = await carregarTweets(currentChannel);
        tweets.forEach(tweet => {
          const post = document.createElement("div");
          post.classList.add("post");
          post.innerHTML = `
            <div class="post-header">
              <img src="${tweet.pic}" class="avatar-small">
              <strong>${tweet.user}</strong>
            </div>
            <p>${tweet.text}</p>
          `;
          // BotÃ£o de deletar se for o dono
          if (tweet.user === currentUser) {
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "ðŸ—‘ï¸";
            deleteBtn.style.marginTop = "5px";
            deleteBtn.addEventListener("click", async () => {
              if (confirm("Deseja apagar este tweet?")) {
                await deletarTweet(tweet.id);
                carregarFeed();
              }
            });
            post.appendChild(deleteBtn);
          }
          feed.appendChild(post);
        });
      }
  
      postarBtn.addEventListener("click", async () => {
        const text = tweetBox.value.trim();
        if (!text) return;
        await salvarTweet(currentChannel, {
          user: currentUser,
          pic: currentPic,
          text
        });
        tweetBox.value = "";
        carregarFeed();
      });
    });
  </script>
  
</head>
<body>
  <!-- PÃ¡gina de Login/Cadastro -->
  <div id="authPage" class="login-page">
    <h2 id="authTitle">Login no Xwitter</h2>
    <input type="text" id="usernameInput" placeholder="Nome de usuÃ¡rio">
    <input type="file" id="profilePicInput" accept="image/*">
    <button id="authBtn">Entrar</button>
  </div>

  <!-- PÃ¡gina Principal -->
  <div id="app" style="display:none;">
    <!-- Sidebar Esquerda -->
    <div class="sidebar">
      <h1>Xwitter</h1>
      <button id="tweetBtn">Tweet</button>
      <hr>
      <h3>ðŸ‘¤ Perfil</h3>
      <img id="profilePic" src="" alt="Perfil" class="avatar">
    </div>

    <!-- ConteÃºdo Principal -->
    <div class="main">
      <h2 id="channelTitle">#geral</h2>
      <textarea id="tweetBox" placeholder="O que estÃ¡ acontecendo?"></textarea>
      <div style="display: flex; gap: 20px; align-items: flex-start;">
        <button id="postar">Tweetar</button>
        <!-- Grupos ao lado do botÃ£o Tweetar -->
        <div class="sidebarR">
          <h3>ðŸ“¢ Grupos</h3>
        </div>
      </div>
      <div id="feed"></div>
    </div>
  </div>
</body>
</html>
